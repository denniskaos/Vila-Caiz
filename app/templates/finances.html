{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <h2>Finanças</h2>
  <p>Controle a saúde financeira do clube e registe novos movimentos.</p>
  {% if active_season %}
    <p class="season-note">Época ativa: <strong>{{ active_season.name }}</strong></p>
  {% endif %}
</section>
<section id="financas">
  <div class="card-grid" style="margin-bottom: 1.5rem;">
    <article class="card">
      <h3>Saldo Atual</h3>
      <p><strong>{{ summary.balance | format_currency }}</strong></p>
      <p>Resultado acumulado.</p>
    </article>
    <article class="card">
      <h3>Total de Receitas</h3>
      <p><strong>{{ summary.total_revenue | format_currency }}</strong></p>
      <p>Entradas registadas.</p>
    </article>
    <article class="card">
      <h3>Total de Despesas</h3>
      <p><strong>{{ summary.total_expense | format_currency }}</strong></p>
      <p>Saídas contabilizadas.</p>
    </article>
  </div>

  {% if revenue_categories or expense_categories %}
    <div class="card" style="margin-bottom: 2rem;">
      <h3>Distribuição por Categoria</h3>
      <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div>
          <h4>Receitas</h4>
          {% if revenue_categories %}
            <ul>
              {% for label, value in revenue_categories.items() %}
                <li><strong>{{ label }}</strong>: {{ value | format_currency }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-state">Sem dados de receitas por categoria.</p>
          {% endif %}
        </div>
        <div>
          <h4>Despesas</h4>
          {% if expense_categories %}
            <ul>
              {% for label, value in expense_categories.items() %}
                <li><strong>{{ label }}</strong>: {{ value | format_currency }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-state">Sem dados de despesas por categoria.</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
</section>

<section id="receitas" aria-labelledby="heading-receitas">
  <h2 id="heading-receitas">Receitas</h2>
  <div class="section-grid section-grid--sidebar">
    <article class="card form-card" aria-labelledby="form-revenue">
      <h3 id="form-revenue">{{ 'Editar Receita' if editing_revenue else 'Registar Receita' }}</h3>
      <form method="post" action="{{ url_for('add_revenue') }}">
        {% if editing_revenue %}
          <input type="hidden" name="revenue_id" value="{{ editing_revenue.id }}" />
        {% endif %}
        <label for="revenue-date">Data</label>
        <input id="revenue-date" name="record_date" type="date" value="{{ editing_revenue.record_date.isoformat() if editing_revenue else '' }}" required />

        <label for="revenue-description">Descrição</label>
        <input id="revenue-description" name="description" type="text" value="{{ editing_revenue.description if editing_revenue else '' }}" required />

        <label for="revenue-category">Categoria</label>
        <input id="revenue-category" name="category" type="text" placeholder="Bilheteira, Patrocínio..." value="{{ editing_revenue.category if editing_revenue else '' }}" required />

        <label for="revenue-source">Origem</label>
        <input id="revenue-source" name="source" type="text" placeholder="Empresa, Sócio..." value="{{ editing_revenue.source if editing_revenue else '' }}" />

        <label for="revenue-amount">Montante (€)</label>
        <input id="revenue-amount" name="amount" type="number" step="0.01" min="0" value="{{ editing_revenue.amount if editing_revenue else '' }}" required />

        <div class="form-actions">
          <button type="submit">{{ 'Atualizar' if editing_revenue else 'Gravar' }}</button>
          {% if editing_revenue %}
            <a href="{{ url_for('finances_revenue_page') }}" class="button secondary">Cancelar</a>
          {% endif %}
        </div>
      </form>
    </article>

    <article class="card">
      <h3>Histórico de Receitas</h3>
      {% if revenues %}
        <div class="table-wrapper">
          <table aria-label="Lista de receitas">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Origem</th>
                <th>Montante</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in revenues %}
                <tr>
                  <td data-label="Data">{{ entry.record_date }}</td>
                  <td data-label="Descrição">{{ entry.description }}</td>
                  <td data-label="Categoria">{{ entry.category }}</td>
                  <td data-label="Origem">{{ entry.source or '-' }}</td>
                  <td data-label="Montante">{{ entry.amount | format_currency }}</td>
                  <td data-label="Ações">
                    <div class="actions">
                      <a href="{{ url_for('finances_revenue_page', edit=entry.id) }}" class="button secondary">Editar</a>
                      <form method="post" action="{{ url_for('delete_revenue', revenue_id=entry.id) }}" class="inline-form">
                        <button type="submit" class="button danger" onclick="return confirm('Confirma a eliminação desta receita?');">Eliminar</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="empty-state">Sem receitas registadas.</p>
      {% endif %}
    </article>
  </div>
</section>

<section id="despesas" aria-labelledby="heading-despesas">
  <h2 id="heading-despesas">Despesas</h2>
  <div class="section-grid section-grid--sidebar">
    <article class="card form-card" aria-labelledby="form-expense">
      <h3 id="form-expense">{{ 'Editar Despesa' if editing_expense else 'Registar Despesa' }}</h3>
      <form method="post" action="{{ url_for('add_expense') }}">
        {% if editing_expense %}
          <input type="hidden" name="expense_id" value="{{ editing_expense.id }}" />
        {% endif %}
        <label for="expense-date">Data</label>
        <input id="expense-date" name="record_date" type="date" value="{{ editing_expense.record_date.isoformat() if editing_expense else '' }}" required />

        <label for="expense-description">Descrição</label>
        <input id="expense-description" name="description" type="text" value="{{ editing_expense.description if editing_expense else '' }}" required />

        <label for="expense-category">Categoria</label>
        <input id="expense-category" name="category" type="text" placeholder="Logística, Equipamentos..." value="{{ editing_expense.category if editing_expense else '' }}" required />

        <label for="expense-vendor">Fornecedor</label>
        <input id="expense-vendor" name="vendor" type="text" placeholder="Nome do fornecedor" value="{{ editing_expense.vendor if editing_expense else '' }}" />

        <label for="expense-amount">Montante (€)</label>
        <input id="expense-amount" name="amount" type="number" step="0.01" min="0" value="{{ editing_expense.amount if editing_expense else '' }}" required />

        <div class="form-actions">
          <button type="submit">{{ 'Atualizar' if editing_expense else 'Gravar' }}</button>
          {% if editing_expense %}
            <a href="{{ url_for('finances_expense_page') }}" class="button secondary">Cancelar</a>
          {% endif %}
        </div>
      </form>
    </article>

    <article class="card">
      <h3>Histórico de Despesas</h3>
      {% if expenses %}
        <div class="table-wrapper">
          <table aria-label="Lista de despesas">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Fornecedor</th>
                <th>Montante</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in expenses %}
                <tr>
                  <td data-label="Data">{{ entry.record_date }}</td>
                  <td data-label="Descrição">{{ entry.description }}</td>
                  <td data-label="Categoria">{{ entry.category }}</td>
                  <td data-label="Fornecedor">{{ entry.vendor or '-' }}</td>
                  <td data-label="Montante">{{ entry.amount | format_currency }}</td>
                  <td data-label="Ações">
                    <div class="actions">
                      <a href="{{ url_for('finances_expense_page', edit=entry.id) }}" class="button secondary">Editar</a>
                      <form method="post" action="{{ url_for('delete_expense', expense_id=entry.id) }}" class="inline-form">
                        <button type="submit" class="button danger" onclick="return confirm('Confirma a eliminação desta despesa?');">Eliminar</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="empty-state">Sem despesas registadas.</p>
      {% endif %}
    </article>
  </div>
</section>
{% if focus_section %}
<script>
  const target = document.getElementById('{{ focus_section }}');
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
{% endif %}
{% endblock %}
