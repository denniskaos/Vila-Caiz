{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <h2>Plantel · {{ selected_squad_label }}</h2>
  <p>Consulta rápida dos {{ selected_squad_label|lower }} registados para a época atual.</p>
  {% if active_season %}
    <p class="season-note">Época ativa: <strong>{{ active_season.name }}</strong></p>
  {% endif %}
  {% if can_manage_players %}
    <p class="page-actions">
      <a class="button" href="{{ url_for('players_manage_page', squad_slug=selected_squad_slug) }}">Gerir este plantel</a>
    </p>
  {% endif %}
</section>

<nav class="squad-nav" aria-label="Plantéis disponíveis">
  {% for option in squad_options %}
    <a
      href="{{ url_for('players_page', squad_slug=option.slug) }}"
      class="{{ 'active' if option.slug == selected_squad_slug else '' }}"
      {% if option.slug == selected_squad_slug %}aria-current="page"{% endif %}
    >
      <span class="squad-name">{{ option.label }}</span>
      <span class="squad-count">{{ option.count }} {{ 'jogador' if option.count == 1 else 'jogadores' }}</span>
    </a>
  {% endfor %}
</nav>

<section class="record-section">
  <div class="card">
    <h3>Plantel {{ selected_squad_label }}</h3>
    {% if players %}
      <div class="entity-grid players-grid">
        {% set youth_squads = ['juniores', 'juvenis', 'iniciados', 'infantis'] %}
        {% for player in players %}
          {% set player_squad_value = player.squad|lower if player.squad else '' %}
          {% set is_youth = player.squad and player.squad|lower in youth_squads %}
          <article class="record-card player-card">
            <header class="record-header">
              <div class="record-avatar">
                {% set player_photo = player.photo_url|photo_path %}
                {% if player_photo %}
                  <img src="{{ player_photo }}" alt="Fotografia de {{ player.name }}" />
                {% else %}
                  <span aria-hidden="true">{{ player.name[:2]|upper }}</span>
                {% endif %}
              </div>
              <div class="record-title">
                <h4>{{ player.name }}</h4>
                <p>
                  <span class="badge badge--number">{{ player.shirt_number or '—' }}</span>
                  {{ player.position }}
                </p>
                <p class="record-subtitle">
                  {{ selected_squad_label if player_squad_value == selected_squad_value else player.squad|title }}
                </p>
              </div>
              <div class="record-extra">
                <span class="badge badge--outline">AF Porto · {{ player.af_porto_id or '—' }}</span>
              </div>
            </header>

            <dl class="record-meta">
              <div>
                <dt>Nascimento</dt>
                <dd>{{ player.birthdate or '—' }}</dd>
              </div>
              <div>
                <dt>Contacto</dt>
                <dd>{{ player.contact or '—' }}</dd>
              </div>
              <div>
                <dt>Mensalidade</dt>
                <dd>
                  {% if is_youth %}
                    <span class="status-chip {{ 'success' if player.youth_monthly_paid else 'pending' }}">
                      {{ 'Pago' if player.youth_monthly_paid else 'Em Falta' }}
                    </span>
                    {% if player.youth_monthly_fee is not none %}
                      <span class="status-detail">{{ player.youth_monthly_fee | format_currency }}</span>
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt>Kit Treino</dt>
                <dd>
                  {% if is_youth %}
                    <span class="status-chip {{ 'success' if player.youth_kit_paid else 'pending' }}">
                      {{ 'Pago' if player.youth_kit_paid else 'Em Falta' }}
                    </span>
                    {% if player.youth_kit_fee is not none %}
                      <span class="status-detail">{{ player.youth_kit_fee | format_currency }}</span>
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </div>
            </dl>

            <div class="record-status">
              {% set treatments = player_treatments.get(player.id, []) %}
              {% if treatments %}
                {% for treatment in treatments %}
                  <div class="status-group">
                    <span class="status-chip {{ 'alert' if treatment.unavailable else 'pending' }}">
                      {{ 'Indisponível' if treatment.unavailable else 'Em Tratamento' }}
                    </span>
                    <p>
                      <strong>{{ treatment.summary }}</strong>
                      {% if treatment.expected_return %}
                        · regresso previsto {{ treatment.expected_return }}
                      {% endif %}
                    </p>
                  </div>
                {% endfor %}
              {% else %}
                <div class="status-group">
                  <span class="status-chip success">Disponível</span>
                  <p>Sem tratamentos clínicos ativos.</p>
                </div>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="empty-state">Ainda não existem jogadores registados para este escalão.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
