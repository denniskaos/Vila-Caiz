{% extends "base.html" %}
{% block content %}
<section class="page-header">
  <h2>Sócios</h2>
  <p>Organize os diferentes perfis de associado, defina valores das quotas e mantenha um histórico transparente dos pagamentos.</p>
</section>
<section class="section-grid">
  <article class="card form-card" aria-labelledby="form-members">
    <h3 id="form-members">Adicionar Sócio</h3>
    <form method="post" action="{{ url_for('add_member') }}">
      <label for="member-name">Nome</label>
      <input id="member-name" name="name" type="text" required />

      <label for="member-birthdate">Data de Nascimento</label>
      <input id="member-birthdate" name="birthdate" type="date" required />

      <label for="member-type-id">Tipo de Sócio</label>
      <select id="member-type-id" name="membership_type_id">
        <option value="">Selecionar um tipo</option>
        {% for membership_type in membership_types %}
          <option value="{{ membership_type.id }}">{{ membership_type.name }} — {{ membership_type.amount|format_currency }} / {{ membership_type.frequency }}</option>
        {% endfor %}
      </select>
      <p class="form-hint">Se ainda não existir, defina um novo tipo abaixo. Pode deixar vazio se selecionar um tipo existente.</p>

      <label for="member-type">Descrição da Quota</label>
      <input id="member-type" name="membership_type" type="text" placeholder="Ex.: Sócio Efetivo" />

      <label for="member-contact">Contacto</label>
      <input id="member-contact" name="contact" type="tel" placeholder="Telefone ou email" />

      <label for="member-dues-until">Quotas válidas até</label>
      <input id="member-dues-until" name="dues_paid_until" type="text" placeholder="Ex.: Dez 2024" />

      <label class="checkbox-label">
        <input type="checkbox" name="dues_paid" /> Quotas em dia
      </label>

      <button type="submit">Registar Sócio</button>
    </form>
  </article>

  <article class="card">
    <h3>Comunidade Vila-Caiz</h3>
    {% if members %}
      <table aria-label="Lista de sócios">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Validade</th>
            <th>Nascimento</th>
            <th>Contacto</th>
          </tr>
        </thead>
        <tbody>
          {% for member in members %}
            {% set type_info = type_lookup.get(member.membership_type_id) if member.membership_type_id is not none else None %}
            <tr>
              <td>{{ member.name }}</td>
              <td>
                {{ member.membership_type or '—' }}
                {% if type_info %}
                  <span class="tag">{{ type_info.amount|format_currency }} / {{ type_info.frequency }}</span>
                {% endif %}
              </td>
              <td>{{ 'Em dia' if member.dues_paid else 'Em atraso' }}</td>
              <td>{{ member.dues_paid_until or '-' }}</td>
              <td>{{ member.birthdate or '-' }}</td>
              <td>{{ member.contact or '-' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="empty-state">Sem sócios registados neste momento.</p>
    {% endif %}
  </article>
</section>

<section class="section-grid">
  <article class="card form-card" aria-labelledby="form-membership-type">
    <h3 id="form-membership-type">Tipos de Sócio</h3>
    <form method="post" action="{{ url_for('create_membership_type') }}">
      <label for="type-name">Nome do Tipo</label>
      <input id="type-name" name="name" type="text" placeholder="Ex.: Sócio Juvenil" required />

      <label for="type-amount">Valor da Quota</label>
      <input id="type-amount" name="amount" type="number" min="0" step="0.01" placeholder="Ex.: 5.00" required />

      <label for="type-frequency">Periodicidade</label>
      <input id="type-frequency" name="frequency" type="text" placeholder="Mensal, Trimestral…" />

      <label for="type-description">Notas</label>
      <textarea id="type-description" name="description" rows="2" placeholder="Benefícios, escalões etários ou outras observações"></textarea>

      <button type="submit">Criar Tipo de Sócio</button>
    </form>
  </article>

  <article class="card">
    <h3>Catálogo de Tipos</h3>
    {% if membership_types %}
      <table aria-label="Tipos de sócio">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Valor</th>
            <th>Periodicidade</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          {% for membership_type in membership_types %}
            <tr>
              <td>{{ membership_type.name }}</td>
              <td>{{ membership_type.amount|format_currency }}</td>
              <td>{{ membership_type.frequency }}</td>
              <td>{{ membership_type.description or '-' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="empty-state">Configure os primeiros tipos para associar quotas automaticamente.</p>
    {% endif %}
  </article>
</section>

<section class="section-grid">
  <article class="card form-card" aria-labelledby="form-membership-payment">
    <h3 id="form-membership-payment">Registar Pagamento de Quotas</h3>
    <form method="post" action="{{ url_for('record_membership_payment') }}">
      <label for="payment-member">Sócio</label>
      <select id="payment-member" name="member_id" required>
        <option value="">Selecione o sócio</option>
        {% for member in members %}
          <option value="{{ member.id }}">[{{ member.id }}] {{ member.name }}</option>
        {% endfor %}
      </select>

      <label for="payment-type">Tipo de Sócio</label>
      <select id="payment-type" name="membership_type_id">
        <option value="">Utilizar o registado no sócio</option>
        {% for membership_type in membership_types %}
          <option value="{{ membership_type.id }}">{{ membership_type.name }}</option>
        {% endfor %}
      </select>

      <label for="payment-period">Período</label>
      <input id="payment-period" name="period" type="text" placeholder="Ex.: Janeiro 2025" required />

      <label for="payment-date">Data do Pagamento</label>
      <input id="payment-date" name="record_date" type="date" required />

      <label for="payment-amount">Valor Pago</label>
      <input id="payment-amount" name="amount" type="number" min="0" step="0.01" required />

      <label for="payment-notes">Notas</label>
      <textarea id="payment-notes" name="notes" rows="2" placeholder="Referência, método de pagamento ou observações"></textarea>

      <button type="submit">Registar Pagamento</button>
    </form>
  </article>

  <article class="card">
    <h3>Histórico de Quotas</h3>
    {% if payments %}
      <ul class="totals">
        <li>Total geral: {{ total_payments|format_currency }}</li>
        {% for key, total in payment_totals.items() %}
          {% if key == 'outros' %}
            <li>Sem tipo associado: {{ total|format_currency }}</li>
          {% else %}
            {% set type_info = type_lookup.get(key) %}
            <li>{{ type_info.name if type_info else 'Tipo #' ~ key }}: {{ total|format_currency }}</li>
          {% endif %}
        {% endfor %}
      </ul>
      <table aria-label="Pagamentos de quotas">
        <thead>
          <tr>
            <th>Data</th>
            <th>Sócio</th>
            <th>Tipo</th>
            <th>Período</th>
            <th>Valor</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments|sort(attribute='paid_on', reverse=True) %}
            {% set member = member_lookup.get(payment.member_id) %}
            {% set type_info = type_lookup.get(payment.membership_type_id) if payment.membership_type_id is not none else None %}
            <tr>
              <td>{{ payment.paid_on }}</td>
              <td>{{ member.name if member else 'Sócio #' ~ payment.member_id }}</td>
              <td>{{ type_info.name if type_info else member.membership_type if member else '-' }}</td>
              <td>{{ payment.period }}</td>
              <td>{{ payment.amount|format_currency }}</td>
              <td>{{ payment.notes or '-' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="empty-state">Ainda não existem pagamentos registados. Quando adicionar um, fica registado aqui de imediato.</p>
    {% endif %}
  </article>
</section>
{% endblock %}
